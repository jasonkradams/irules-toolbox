# Rule to redirect requests which aren't made to www.domain.com to https://www.domain.com/[uri]
# If the address matches, distribute requests to /us* to pool US_pool, /au* to AU_pool and everything else to default_pool

when HTTP_REQUEST {
  if {not ([string tolower [HTTP::host]] eq "www.domain.com")}{
    HTTP::redirect https://www.domain.com[HTTP::uri]
  } else {
    switch -glob -- [HTTP::path] {
      "/us*" {
        pool US_pool
        log local0. "[IP::client_addr]:[TCP::client_port]: using pool US_pool"
      }
      "/au*" {
        pool AU_pool
        log local0. "[IP::client_addr]:[TCP::client_port]: using pool AU_pool"
      }
      default {
        pool default_pool
        log local0. "[IP::client_addr]:[TCP::client_port]: using default pool"
      }
    }
  }
}
